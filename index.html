<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ammo Price Checker</title>
<style>
  body, #container, #ammoInput, #suggestions, #suggestions div, .ammo-details, .ammo-details img, .ammo-info, .pin-button {
    font-family: Arial, sans-serif;
    background-color: #2e2e2e;
    color: #fff;
  body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  #container {
    background-color: #1e1e1e;
    border-radius: 15px;
    padding: 30px;
    max-width: 600px;
    width: 100%;
    text-align: left;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
    position: relative;
  }
  #ammoInput {
    background-color: #3b3b3b;
    padding: 10px;
    border: none;
    width: 100%;
    border-radius: 5px;
    position: relative;
    z-index: 10;
    margin-bottom: 10px;
  }
  #suggestions {
    display: none;
    background-color: #444;
    padding: 5px;
    position: absolute;
    width: calc(100% - 60px);
    max-width: 600px;
    left: 0;
    margin-top: 5px;
    border-radius: 5px;
    z-index: 15;
  }
  #suggestions.visible {
    display: block;
  }
  #suggestions div {
    padding: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: #2d2d2d;
    border-bottom: 1px solid #555;
  }
  #suggestions div:hover {
    background-color: #555;
  }
  .ammo-details {
    display: flex;
    align-items: center;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #d3d3d3;
    margin-bottom: 15px;
    position: relative;
  }
  .ammo-details img {
    width: 100px;
    height: auto;
    margin-right: 20px;
  }
  .ammo-info {
    line-height: 1.5;
  }
  .ammo-info strong {
    font-size: 1.2em;
    display: block;
    margin-bottom: 10px;
  }
  .pin-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #3b3b3b;
    border: none;
    cursor: pointer;
    font-size: .9em;
    border-radius: 10px;
    padding: 5px 10px;
  }
</style>
</head>
<body>
  <div id="container">
    <h3 style="text-align:center; color:gold;">BETA VERSION</h3>
    <div style="text-align: center;"><img src="https://i.ibb.co/x2DQB2b/TKGBROKERLOGO.png" alt="TKG Ammo Broker Logo" style="max-width: 100%; height: auto;"></div>
    <label for="ammoInput">SEARCH FOR AMMO:</label>
    <input type="text" id="ammoInput" oninput="handleInput()">
    <div id="suggestions"></div>
    <div id="ammoList"></div>
    <div id="pinnedAmmoList"></div>
  </div>
  
  <script>
  let allAmmoData = [];

  async function fetchAmmoPrices() {
    try {
      const response = await fetch('https://api.tarkov.dev/graphql', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: JSON.stringify({
          query: `{
            items(type: ammo) {
              id
              name
              avg24hPrice
              low24hPrice
              high24hPrice
              fleaMarketFee
              sellFor {
                vendor {
                  name
                }
                price
              }
              image8xLink
              gridImageLink
            }
          }`,
        }),
      });
      const result = await response.json();

      if (result.data && result.data.items) {
        allAmmoData = result.data.items;
      } else {
        console.error('Unexpected response structure:', result);
      }
    } catch (error) {
      console.error('Error fetching ammo prices:', error);
    }
  }

  function handleInput() {
    const input = document.getElementById('ammoInput').value.toLowerCase();
    const suggestionsDiv = document.getElementById('suggestions');
    suggestionsDiv.innerHTML = '';

    if (input.length === 0) {
      suggestionsDiv.classList.remove('visible');
      return;
    }

    const suggestions = allAmmoData.filter(ammo => ammo.name.toLowerCase().includes(input)).slice(0, 3);

    if (suggestions.length > 0) {
      suggestionsDiv.classList.add('visible');
    } else {
      suggestionsDiv.classList.remove('visible');
    }

    suggestions.forEach(ammo => {
      const suggestion = document.createElement('div');
      suggestion.onclick = () => selectAmmo(ammo);

      const ammoName = document.createElement('span');
      ammoName.textContent = ammo.name;

      const ammoImage = document.createElement('img');
      ammoImage.src = ammo.gridImageLink;
      ammoImage.alt = ammo.name;

      suggestion.appendChild(ammoName);
      suggestion.appendChild(ammoImage);
      suggestionsDiv.appendChild(suggestion);
    });
  }

  function selectAmmo(ammo) {
    const ammoListDiv = document.getElementById('ammoList');
    const suggestionsDiv = document.getElementById('suggestions');
    suggestionsDiv.innerHTML = '';
    suggestionsDiv.classList.remove('visible');

    // Clear previous non-pinned ammo details
    ammoListDiv.innerHTML = '';

    const avgPrice = ammo.avg24hPrice ? ammo.avg24hPrice : 'N/A';
    const lowPrice = ammo.low24hPrice ? ammo.low24hPrice : 'N/A';
    const highPrice = ammo.high24hPrice ? ammo.high24hPrice : 'N/A';
    const fleaMarketFee = ammo.fleaMarketFee ? ammo.fleaMarketFee : 'N/A';
    const imageLink = ammo.image8xLink ? `<img src="${ammo.image8xLink}" alt="${ammo.name}">` : '';

    let fleaMarketPrice = 'N/A';
    if (ammo.sellFor && ammo.sellFor.length > 0) {
      const fleaMarket = ammo.sellFor.find(sell => sell.vendor.name === 'Flea Market');
      if (fleaMarket) {
        fleaMarketPrice = fleaMarket.price;
      }
    }

    let ammoDetailsContent = `
      ${imageLink}
      <div class="ammo-info">
        <strong>${ammo.name}</strong>
    `;

    if (fleaMarketPrice === 'N/A') {
      ammoDetailsContent += `
        <span>❌ Sorry, this item is not available on the Flea Market!</span>
      `;
    } else {
      ammoDetailsContent += `
        FLEA MARKET: ₽${fleaMarketPrice}<br>
        FLEA FEE: ₽${fleaMarketFee}<br>
        24HR AVG: ₽${avgPrice}<br>
        24HR HI: ₽${highPrice}<br>
        24HR LOW: ₽${lowPrice}<br>
      `;
    }

    ammoDetailsContent += `</div>
      <button class="pin-button" onclick="pinAmmo(event, '${ammo.id}')">Pin</button>
    `;

    const ammoDetails = document.createElement('div');
    ammoDetails.classList.add('ammo-details');
    ammoDetails.innerHTML = ammoDetailsContent;

    ammoListDiv.appendChild(ammoDetails);
  }

  function pinAmmo(event, ammoId) {
    event.stopPropagation();
    const ammo = allAmmoData.find(item => item.id === ammoId);
    if (!ammo) return;

    const pinnedAmmoListDiv = document.getElementById('pinnedAmmoList');

    // Check if the ammo is already pinned
    if (Array.from(pinnedAmmoListDiv.children).some(child => child.dataset.id === ammoId)) {
      return;
    }

    const avgPrice = ammo.avg24hPrice ? ammo.avg24hPrice : 'N/A';
    const lowPrice = ammo.low24hPrice ? ammo.low24hPrice : 'N/A';
    const highPrice = ammo.high24hPrice ? ammo.high24hPrice : 'N/A';
    const fleaMarketFee = ammo.fleaMarketFee ? ammo.fleaMarketFee : 'N/A';
    const imageLink = ammo.image8xLink ? `<img src="${ammo.image8xLink}" alt="${ammo.name}">` : '';

    let fleaMarketPrice = 'N/A';
    if (ammo.sellFor && ammo.sellFor.length > 0) {
      const fleaMarket = ammo.sellFor.find(sell => sell.vendor.name === 'Flea Market');
      if (fleaMarket) {
        fleaMarketPrice = fleaMarket.price;
      }
    }

    let pinnedAmmoDetailsContent = `
      ${imageLink}
      <div class="ammo-info">
        <strong>${ammo.name}</strong>
    `;

    if (fleaMarketPrice === 'N/A') {
      pinnedAmmoDetailsContent += `
        <span>❌ Sorry, this item is not available on the Flea Market!</span>
      `;
    } else {
      pinnedAmmoDetailsContent += `
        FLEA MARKET: ₽${fleaMarketPrice}<br>
        FLEA FEE: ₽${fleaMarketFee}<br>
        24HR AVG: ₽${avgPrice}<br>
        24HR HI: ₽${highPrice}<br>
        24HR LOW: ₽${lowPrice}<br>
      `;
    }

    pinnedAmmoDetailsContent += `</div>
      <button class="pin-button" onclick="unpinAmmo('${ammo.id}')">Unpin</button>
    `;

    const pinnedAmmoDetails = document.createElement('div');
    pinnedAmmoDetails.classList.add('ammo-details');
    pinnedAmmoDetails.dataset.id = ammoId;
    pinnedAmmoDetails.innerHTML = pinnedAmmoDetailsContent;

    pinnedAmmoListDiv.appendChild(pinnedAmmoDetails);
  }

  function unpinAmmo(ammoId) {
    const pinnedAmmoListDiv = document.getElementById('pinnedAmmoList');
    const pinnedAmmo = Array.from(pinnedAmmoListDiv.children).find(child => child.dataset.id === ammoId);
    if (pinnedAmmo) {
      pinnedAmmoListDiv.removeChild(pinnedAmmo);
    }
  }

  window.onload = fetchAmmoPrices;
</script>
</body>
</html>
